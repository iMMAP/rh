{% load static %}

<form action="" method="post" 
    class="bg-white rounded border border-gray-e6" 
    id="target-location-form"
>
    <div class="flex items-center justify-between border-b border-red-b5 p-4 bg-gray-f5">
        <span class="activity-title">
            Targeted Locations
        </span>
        <div class="inline-deletelink" onclick="this.closest('form').remove()">
        </div>
    </div>

    {% csrf_token %}
    <div class="select-field p-4">
        <span class="label">Target Location</span>
        {{ location_report_form.target_location }}
        <select name="options" id="options">
            <option value="option1">Option 1</option>
            <option value="option2">Option 2</option>
            <option value="option3">Option 3</option>
        </select>
    </div>

    <div class="disaggregation-block js-inline-admin-formset inline-group p-4"
        id="{{ report_disaggregation_formset.prefix }}-group"
        data-inline-type="tabular"
        data-inline-formset='{"name":"#{{ report_disaggregation_formset.prefix }}","options":{"prefix":"{{ report_disaggregation_formset.prefix }}","addText":"Add another","deleteText":"Delete"}}'
    >
        <p class="pb-4">
            The Disaggregation list is selected from the Indicator of your Activity plan. If there is someting missing, please contact your cluster.
        </p>
        {{ report_disaggregation_formset.management_form }}
        <fieldset class="table-wrapper-scrollable">
            <table class="table border border-solid border-gray-d1 rounded">
                <thead class="content-block bg-gray-f3">
                    <tr class="divide-x">
                        {% for field in report_disaggregation_formset.form.fields %}
                            <th class="border-r border-gray-e6 column-{{ field.name }}{% if field.required %} required{% endif %}{% if field.widget.is_hidden %} hidden{% endif %}">
                                {{ field|capfirst }}
                            </th>
                        {% endfor %}
                        <th>Random Heading 1</th>
                        <th>Random Heading 2</th>
                        <th>Random Heading 3</th>
                        {% if report_disaggregation_formset.can_delete %}<th>Delete?</th>{% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for form in report_disaggregation_formset %}
                        {% if form.non_field_errors %}
                            <tr class="row-form-errors">
                                <td colspan="4">{{ form.non_field_errors }}</td>
                            </tr>
                        {% endif %}

                        <tr class="form-row {% if forloop.last %}empty-form{% endif %} {% if form.instance.pk %}has_original{% endif %}"
                            id="{{ report_disaggregation_formset.prefix }}-{% if forloop.last %}empty{% else %}{{ forloop.counter0 }}{% endif %}"
                        >
                            {% for field in form %}
                                {% if field.name != "DELETE" %}
                                    <td class="{% if field.name %}field-{{ field.name }}{% endif %}{% if field.is_hidden %} hidden{% endif %} ">
                                        {{ field }}
                                        {{ field.errors }}
                                    </td>
                                {% endif %}
                            {% endfor %}
                            <td class="delete">
                                {% if form.instance.pk %}{{ form.DELETE }}{% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                    <td>Random Content 1</td>
                    <td>Random Content 2</td>
                    <td>Random Content 3</td>
                </tbody>
            </table>
        </fieldset>
    </div>

    <div class="plan-submit-holder">
        <div> </div>
        <div>
            <a href="#" class="btn btn-gray">Delete</a>
            <input type="submit" name="_save" class="btn btn-red" value="Save">
        </div>
    </div>
</form>

{% block scripts %}
    <script defer src="{% static 'js/utils/inlines.js' %}"></script>
    <script>
        /**
         * Handle Auto-population of target location report fields.
         * @param {string} targetLocationId - ID of the selected target location.
         **/
        function autoPopulateTargetLocationReport(targetLocationId) {
            const formElement = $('#location-form'); // Adjust the selector as needed

            $.ajax({
                url: '/ajax/get_target_location_auto_fields/',
                data: {
                    'target_location': targetLocationId
                },
                type: 'POST',
                dataType: 'json',
                beforeSend: function(xhr, settings) {
                    xhr.setRequestHeader("X-CSRFToken", $('input[name="csrfmiddlewaretoken"]').val());
                },
                success: function(data) {
                    debugger
                    let country = formElement.find(`#id_country`);
                    let province = formElement.find(`#id_province`);
                    let district = formElement.find(`#id_district`);
                    let zone = formElement.find(`#id_zone`);
                    let facility_monitoring = formElement.find(`#id_facility_monitoring`);
                    let facility_name = formElement.find(`#id_facility_name`);
                    let facility_id = formElement.find(`#id_facility_id`);
                    let facility_lat = formElement.find(`#id_facility_lat`);
                    let facility_long = formElement.find(`#id_facility_long`);
                    let nhs_code = formElement.find(`#id_nhs_code`);
                    let facilityDetails = formElement.find(`#facility_details`);

                    country.val(data.country);
                    province.val(data.province);
                    district.val(data.district);
                    zone.val(data.zone);
                    facility_monitoring.prop('checked', data.facility_monitoring);
                    nhs_code.val(data.nhs_code);

                    if (data.facility_monitoring) {
                        facilityDetails.show();
                        facility_name.val(data.facility_name);
                        facility_id.val(data.facility_id);
                        facility_lat.val(data.facility_lat);
                        facility_long.val(data.facility_long);
                    } else {
                        facilityDetails.hide();
                    }
                },
                error: function(error) {
                    console.log('Error fetching form data:', error);
                }
            });
        };
    </script>
{% endblock scripts %}
