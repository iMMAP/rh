{% load static %}
{% load compress %}

<form 
    class="bg-white rounded border border-gray-e6" 
    id="{{location_report_form.prefix}}"
    hx-post="{% url 'create_report_target_locations' plan_report.monthly_report.id %}"
    hx-swap="outerHTML"  
>
    <div class="flex items-center justify-between border-b border-red-b5 p-4 bg-gray-f5">
        <span class="title font-bold text-red-a5">
            Targeted Location
        </span>
        <div class="inline-deletelink" onclick="this.closest('form').remove()">
        </div>
    </div>

    {% csrf_token %}
    <div class="select-field p-4">
        <span class="label">Target Location</span>
        {{ location_report_form.target_location }}
    </div>

    <div class="disaggregation-block js-inline-admin-formset-{{report_disaggregation_formset.prefix}} inline-group p-4"
        id="{{ report_disaggregation_formset.prefix }}-group"
        data-inline-type="tabular"
        data-inline-formset='{"name":"#{{ report_disaggregation_formset.prefix }}","options":{"prefix":"{{ report_disaggregation_formset.prefix }}","addText":"Add another","deleteText":"Delete"}}'
    >
        <div class="tabular inline-related">
            <p class="pb-4">
                The Disaggregation list is selected from the Indicator of your Activity plan. If there is someting missing, please contact your cluster.
            </p>
            {{ report_disaggregation_formset.management_form }}
            <fieldset class="table-wrapper-scrollable">
                <table class="table border border-solid border-gray-d1 rounded">
                    <thead class="content-block bg-gray-f3">
                        <tr class="divide-x">
                            {% for field in report_disaggregation_formset.form.fields %}
                                <th class="border-r border-gray-e6 column-{{ field.name }}{% if field.required %} required{% endif %}{% if field.widget.is_hidden %} hidden{% endif %}">
                                    {{ field|capfirst }}
                                </th>
                            {% endfor %}
                            {% if report_disaggregation_formset.can_delete %}<th>Delete?</th>{% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for form in report_disaggregation_formset %}
                            {% if form.non_field_errors %}
                                <tr class="row-form-errors">
                                    <td colspan="4">{{ form.non_field_errors }}</td>
                                </tr>
                            {% endif %}

                            <tr class="form-row {% if forloop.last %}empty-form{% endif %} {% if form.instance.pk %}has_original{% endif %}"
                                id="{{ report_disaggregation_formset.prefix }}-{% if forloop.last %}empty{% else %}{{ forloop.counter0 }}{% endif %}"
                            >
                                {% for field in form %}
                                    {% if field.name != "DELETE" %}
                                        <td class="{% if field.name %}field-{{ field.name }}{% endif %}{% if field.is_hidden %} hidden{% endif %} ">
                                            {{ field }}
                                            {{ field.errors }}
                                        </td>
                                    {% endif %}
                                {% endfor %}
                                <td class="delete">
                                    {% if form.instance.pk %}{{ form.DELETE }}{% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </fieldset>
        </div>
    </div>

    <div class="plan-submit-holder">
        <div></div>
        <div>
            <a href="#" class="btn btn-gray">Delete</a>
            <input type="submit" name="_save" class="btn btn-red" value="Save">
        </div>
    </div>
    <script>
        document.querySelectorAll(".js-inline-admin-formset-{{report_disaggregation_formset.prefix}}").forEach((element) => {
            const data = element.dataset;
            const inlineOptions = JSON.parse(data.inlineFormset);
            const selector = `${inlineOptions.name}-group .tabular.inline-related tbody > tr.form-row`;

            // defined in inlines.js file
            tabularFormset(
                document.querySelectorAll(selector),
                inlineOptions.options,
            );
        });
    </script>
</form>

